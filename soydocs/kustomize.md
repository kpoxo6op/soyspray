# Patching Helm Charts with Kustomize in Argo CD

This document outlines how to use Kustomize to patch resources generated by a
Helm chart when deploying via Argo CD. This is particularly useful for
overriding specific fields that might not be exposed via Helm `values.yaml` or
for ensuring specific configurations are applied post-Helm rendering.

We encountered this scenario with Longhorn, where we needed to explicitly set
resource requests and limits for certain pods (`longhorn-csi-plugin`,
`engine-image-*`) that were defaulting to `BestEffort` QoS class, leading to
OOMKills or instability under node pressure.

## Steps

1. **Identify the Target Resource:** Determine the `apiVersion`, `kind`, `name`,
    and `namespace` of the Kubernetes resource you want to patch (e.g., a
    `Deployment`, `DaemonSet`). You can find this by rendering the Helm chart
    locally if needed:

    ```bash
    # Example for Longhorn
    helm template <release-name> longhorn/longhorn --version <chart-version> --namespace <target-namespace> --values <path-to-values.yaml> > helm-output.yaml
    # Search helm-output.yaml for the resource definition
    ```

2. **Create a Patch File:** Create a YAML file (e.g., in a `patches/`
    subdirectory) defining the changes you want to make. Use the same
    `apiVersion`, `kind`, `metadata.name`, and `metadata.namespace` as the
    target resource. Only include the fields you want to add or modify.

    *Example (`patches/csi-plugin-resources.yaml`):*

    ```yaml
    # playbooks/yaml/argocd-apps/longhorn/patches/csi-plugin-resources.yaml
    apiVersion: apps/v1
    kind: DaemonSet
    metadata:
      name: longhorn-csi-plugin
      # Namespace is crucial for Kustomize to find the target
      namespace: longhorn-system
    spec:
      template:
        spec:
          containers:
            # Target the specific container
            - name: longhorn-csi-plugin
              # Define the resources to apply
              resources:
                requests:
                  cpu: "150m"
                  memory: "200Mi"
                limits:
                  cpu: "300m"
                  memory: "400Mi"
    ```

3. **Create/Update `kustomization.yaml`:** In the same directory where Argo CD
    will look for manifests (defined by `spec.source.path` in the Application
    CRD), create or modify `kustomization.yaml`:
    * Use `helmCharts` to reference the base Helm chart and your `values.yaml`.
    * Use the `patches` field (preferred over the deprecated
      `patchesStrategicMerge`) to apply your patch file(s).
    * **Crucially:** Explicitly define the `target` for the patch if Kustomize
      has trouble finding the resource generated by Helm.

    *Example (`kustomization.yaml`):*

    ```yaml
    apiVersion: kustomize.config.k8s.io/v1beta1
    kind: Kustomization

    # Define the namespace for resources generated here and targeted by patches
    namespace: longhorn-system

    helmCharts:
      - name: longhorn
        repo: https://charts.longhorn.io
        version: 1.8.0
        releaseName: longhorn
        namespace: longhorn-system # Helm needs namespace too
        valuesFile: values.yaml

    patches:
      - path: patches/csi-plugin-resources.yaml
        # Explicit target definition helps Kustomize resolve ambiguity
        target:
          kind: DaemonSet
          name: longhorn-csi-plugin
          # Namespace can often be inferred from top-level, but explicit helps
          # namespace: longhorn-system
    ```

4. **Configure Argo CD Application:** Ensure your Argo CD `Application` resource
    uses a single `spec.source` pointing to the directory containing your
    `kustomization.yaml` and includes the `kustomize:` block. Remove any
    conflicting `spec.sources` block.

    *Example (`longhorn-application.yaml`):*

    ```yaml
    apiVersion: argoproj.io/v1alpha1
    kind: Application
    metadata:
      name: longhorn
      namespace: argocd
    spec:
      project: default
      source:
        repoURL: <your-git-repo-url>
        targetRevision: <your-branch-or-tag> # e.g., main, limits
        path: playbooks/yaml/argocd-apps/longhorn # Path to kustomization.yaml dir
        kustomize: {} # Enable Kustomize
      destination:
        server: "https://kubernetes.default.svc"
        namespace: longhorn-system # Target namespace for deployment
      syncPolicy:
        # ...
    ```

5. **Troubleshooting:**
    * **Error: `no resource matches...` / `failed to find unique target...`:**
        * Ensure the `metadata.namespace` is defined in your patch file.
        * Explicitly define the `target` (with `kind` and `name`) in the
          `patches` section of `kustomization.yaml`.
        * Verify the `name` in your patch exactly matches the name generated by
          the Helm chart by rendering it locally (`helm template ...`).
    * **Verify Locally:** Test your setup locally before committing/syncing:

        ```bash
        # Navigate to the directory with kustomization.yaml
        kustomize build . --enable-helm
        ```

        Inspect the output YAML to confirm the patch was applied correctly.

By following these steps, you can reliably apply specific overrides or additions
to resources managed by Helm charts deployed via Argo CD.
