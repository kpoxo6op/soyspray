apiVersion: v1
kind: ConfigMap
metadata:
  name: loki-rules-backup
  namespace: monitoring
  labels:
    app.kubernetes.io/name: loki
    app.kubernetes.io/component: ruler
    app.kubernetes.io/part-of: observability
    loki.grafana.com/rule: "1"
data:
  immich-backup.yaml: |
    groups:
      - name: immich-backup
        rules:
          - alert: ImmichMediaBackupFailureImmediate
            expr: |
              sum by (namespace, message) (
                count_over_time({namespace="immich", container="aws-sync"}
                  |~ "(?i)(an error occurred \\(|error|accessdenied|expiredtoken|slowdown|requesttimetoo skewed|read-only file system|connection reset)"
                  | regexp "(?P<message>.*)"
                  [5m])
              ) > 0
            for: 1m
            labels:
              severity: warning
            annotations:
              summary: "Immich media offsite sync failed"
              description: "Log error: {{ $labels.message }}"

  immich-backup-events.yaml: |
    groups:
      - name: immich-backup-events
        rules:
          - alert: ImmichMediaBackupBackoffLimitExceeded
            expr: |
              count_over_time({cluster="soyspray", job="kubernetes-events"} |= "BackoffLimitExceeded" |= "immich-media-offsite-sync" [5m]) > 0
            for: 1m
            labels:
              severity: warning
            annotations:
              summary: "immich-media-offsite-sync backoff limit exceeded"
              description: "Kubernetes reports BackoffLimitExceeded for immich-media-offsite-sync."

  cnpg-backup.yaml: |
    groups:
      - name: cnpg-backup
        rules:
          - alert: CNPGBackupBarmanError
            expr: |
              sum by (namespace) (
                count_over_time({namespace="postgresql"} |= "barman"
                  |~ "(?i)(error|failed|fatal)" [5m])
              ) > 0
            for: 2m
            labels:
              severity: critical
            annotations:
              summary: "CNPG barman backup error"
              description: "CNPG cluster logs contain barman ERROR/failed in the last 5m."

          - alert: CNPGWalArchiveFailure
            expr: |
              sum by (namespace) (
                count_over_time({namespace="postgresql"}
                  |~ "(?i)archive_command.*(failed|returned)" [5m])
              ) > 0
            for: 2m
            labels:
              severity: critical
            annotations:
              summary: "PostgreSQL WAL archiving failing (archive_command)"
              description: "postgres reports archive_command failure in the last 5m."

  obsidian-backup.yaml: |
    groups:
      - name: obsidian-backup
        rules:
          - alert: ObsidianBackupFailureImmediate
            expr: |
              sum by (namespace) (
                count_over_time({namespace="obsidian", container="backup"}
                  |~ "(?i)(error|failed|fatal|command not found|Missing|Failed to)" [5m])
              ) > 0
            for: 2m
            labels:
              severity: warning
            annotations:
              summary: "Obsidian CouchDB backup failed"
              description: "Obsidian backup job in obsidian namespace is emitting errors in the last 5m."

  obsidian-backup-events.yaml: |
    groups:
      - name: obsidian-backup-events
        rules:
          - alert: ObsidianBackupBackoffLimitExceeded
            expr: |
              count_over_time({cluster="soyspray", job="kubernetes-events"} |= "BackoffLimitExceeded" |= "obsidian-couchdb-offsite-backup" [5m]) > 0
            for: 1m
            labels:
              severity: warning
            annotations:
              summary: "obsidian-couchdb-offsite-backup backoff limit exceeded"
              description: "Kubernetes reports BackoffLimitExceeded for obsidian-couchdb-offsite-backup."

  backup-error-burst.yaml: |
    groups:
      - name: backup-error-burst
        rules:
          - alert: BackupErrorBurst
            expr: |
              sum by (namespace) (
                rate(({namespace=~"immich|postgresql|obsidian"} |~ "(?i)(error|failed|fatal)")[5m])
              ) > 0.5
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "Backup error burst"
              description: "Sustained error rate detected across backup logs."

