apiVersion: batch/v1
kind: CronJob
metadata:
  name: obsidian-couchdb-offsite-backup
  namespace: obsidian
spec:
  schedule: "55 12 * * *"
  timeZone: "Pacific/Auckland"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 3
  startingDeadlineSeconds: 3600
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 3600
      ttlSecondsAfterFinished: 86400
      template:
        spec:
          serviceAccountName: obsidian-offsite-backup
          restartPolicy: Never
          terminationGracePeriodSeconds: 30
          containers:
            - name: backup
              image: public.ecr.aws/aws-cli/aws-cli:2.15.0
              imagePullPolicy: IfNotPresent
              command: ["/bin/bash", "/scripts/backup-couchdb.sh"]
              envFrom:
                - secretRef:
                    name: obsidian-offsite-writer
              env:
                - name: COUCHDB_URL
                  value: "http://obsidian-livesync-svc-couchdb.obsidian.svc.cluster.local:5984"
                - name: COUCHDB_USER
                  valueFrom:
                    secretKeyRef:
                      name: obsidian-livesync-couchdb
                      key: adminUsername
                - name: COUCHDB_PASS
                  valueFrom:
                    secretKeyRef:
                      name: obsidian-livesync-couchdb
                      key: adminPassword
              volumeMounts:
                - name: scripts
                  mountPath: /scripts
                  readOnly: true
              resources:
                requests:
                  cpu: "100m"
                  memory: "256Mi"
                limits:
                  memory: "512Mi"
          volumes:
            - name: scripts
              configMap:
                name: obsidian-offsite-backup-scripts
                defaultMode: 0555

