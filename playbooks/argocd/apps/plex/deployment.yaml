# playbooks/argocd/apps/plex/deployment.yaml
# Bare-metalâ€“like Deployment: hostNetwork for Direct access via UPnP, library PVC at /data,
# and a postStart that auto-claims using PLEX_ACCOUNT_TOKEN.

apiVersion: apps/v1
kind: Deployment
metadata:
  name: plex
  namespace: media
  labels:
    app: plex
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: plex
  template:
    metadata:
      labels:
        app: plex
    spec:
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      containers:
        - name: plex
          image: linuxserver/plex:1.41.3
          imagePullPolicy: IfNotPresent
          env:
            - name: PLEX_ACCOUNT_TOKEN
              valueFrom:
                secretKeyRef:
                  name: plex-account-token
                  key: token
          ports:
            - name: http
              containerPort: 32400
              protocol: TCP
          lifecycle:
            postStart:
              exec:
                command:
                  - /bin/bash
                  - /tmp/poststart/poststart.sh
          volumeMounts:
            - name: media
              mountPath: /data
              readOnly: true
            - name: poststart
              mountPath: /tmp/poststart
              readOnly: true
      volumes:
        - name: media
          persistentVolumeClaim:
            claimName: sonarr-tv
        - name: poststart
          configMap:
            name: plex-poststart
            defaultMode: 0755
