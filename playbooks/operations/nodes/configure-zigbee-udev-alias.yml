# playbooks/operations/nodes/configure-zigbee-udev-alias.yml
# This playbook creates a udev alias for the Sonoff ZBDongle-P Zigbee coordinator
# The alias /dev/ttyUSB.zigbee provides a stable device path for Zigbee2MQTT

---
- name: Common tasks for every playbook
  import_playbook: ../../../kubespray/playbooks/boilerplate.yml

- name: Configure udev alias for Zigbee USB dongle
  hosts: kube_control_plane,kube_node
  become: true
  vars:
    zigbee_vendor_id: "10c4"
    zigbee_product_id: "ea60"
    zigbee_alias: "ttyUSB.zigbee"
    udev_rule_file: "/etc/udev/rules.d/99-zigbee.rules"
  tasks:
    - name: Check if Zigbee USB device is present
      ansible.builtin.command: lsusb | grep -i "{{ zigbee_vendor_id }}:{{ zigbee_product_id }}"
      register: usb_check
      changed_when: false
      failed_when: false

    - name: Display USB device status
      ansible.builtin.debug:
        msg: "Zigbee USB device is {{ 'detected' if usb_check.rc == 0 else 'not detected' }}"

    - name: Create udev rule for Zigbee USB dongle alias
      ansible.builtin.copy:
        dest: "{{ udev_rule_file }}"
        content: |
          SUBSYSTEM=="tty", ATTRS{idVendor}=="{{ zigbee_vendor_id }}", ATTRS{idProduct}=="{{ zigbee_product_id }}", SYMLINK+="{{ zigbee_alias }}"
        mode: "0644"
        owner: root
        group: root
      when: usb_check.rc == 0

    - name: Reload udev rules
      ansible.builtin.command: udevadm control --reload-rules
      when: usb_check.rc == 0

    - name: Trigger udev to apply rules
      ansible.builtin.command: udevadm trigger
      when: usb_check.rc == 0

    - name: Wait for udev to create symlink
      ansible.builtin.pause:
        seconds: 2
      when: usb_check.rc == 0

    - name: Verify Zigbee alias exists
      ansible.builtin.stat:
        path: "/dev/{{ zigbee_alias }}"
      register: alias_check
      when: usb_check.rc == 0

    - name: Display alias status
      ansible.builtin.debug:
        msg: "Zigbee alias /dev/{{ zigbee_alias }} is {{ 'created' if (alias_check.stat is defined and alias_check.stat.exists) else 'not found' }}"
      when: usb_check.rc == 0

    - name: Display alias target if exists
      ansible.builtin.command: readlink -f /dev/{{ zigbee_alias }}
      register: alias_target
      changed_when: false
      failed_when: false
      when: usb_check.rc == 0 and (alias_check.stat is defined and alias_check.stat.exists)

    - name: Show alias target
      ansible.builtin.debug:
        msg: "Alias /dev/{{ zigbee_alias }} points to {{ alias_target.stdout }}"
      when: usb_check.rc == 0 and alias_target is defined and alias_target.rc == 0

