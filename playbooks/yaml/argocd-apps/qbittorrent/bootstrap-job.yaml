# playbooks/yaml/argocd-apps/qbittorrent/bootstrap-job.yaml
# Fix login parameter expansion and ensure authentication before readiness checks
# Wait for login to succeed, then poll version endpoint using session cookie
apiVersion: batch/v1
kind: Job
metadata:
  name: qbittorrent-bootstrap
  namespace: media
  labels:
    app: qbittorrent-bootstrap
    component: bootstrap
  annotations:
    argocd.argoproj.io/hook: PostSync
spec:
  ttlSecondsAfterFinished: 3600
  template:
    metadata:
      labels:
        app: qbittorrent-bootstrap
        component: bootstrap
    spec:
      restartPolicy: OnFailure
      containers:
      - name: bootstrap
        image: curlimages/curl:8.8.0
        env:
        - name: BASE_URL
          value: "http://qbittorrent.media.svc.cluster.local:8080"
        - name: QB_LOGIN
          value: "admin:123"
        command:
        - sh
        - -ce
        - |
          login() {
            echo "Logging in to qBittorrent..."
            curl -fsSL -c /tmp/cookie \
              -d "username=${QB_LOGIN%%:*}&password=${QB_LOGIN#*:}" \
              "${BASE_URL}/api/v2/auth/login"
          }
          echo "Waiting for login to succeed..."
          until login; do
            echo "Login failed, retrying in 5s..."
            sleep 5
          done
          echo "Login successful"

          echo "Waiting for API to be ready..."
          until curl -fsSL -b /tmp/cookie -f "${BASE_URL}/api/v2/app/webapiVersion" > /dev/null 2>&1; do
            echo "API not ready, retrying in 5s..."
            sleep 5
          done
          echo "API ready"

          echo "Creating categories..."
          for cat in tv movies books audiobooks scenes; do
            echo "Creating category: $cat"
            curl -fsSL -b /tmp/cookie \
              -d "category=$cat" \
              "${BASE_URL}/api/v2/torrents/createCategory"
          done
          echo "qBittorrent categories configured successfully"
        resources:
          requests:
            memory: "32Mi"
            cpu: "50m"
          limits:
            memory: "64Mi"
            cpu: "100m"
        securityContext:
          allowPrivilegeEscalation: false
          runAsNonRoot: true
          runAsUser: 65534
          capabilities:
            drop:
            - ALL
