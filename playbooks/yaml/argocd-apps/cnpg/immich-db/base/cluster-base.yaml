# CNPG Cluster base shared by A/B and all modes (initdb/prod/restore). No bootstrap, no backup.
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: immich-db
spec:
  instances: 1
  imageName: ghcr.io/tensorchord/cloudnative-pgvecto.rs:16-v0.3.0
  storage:
    size: 20Gi
    storageClass: longhorn
  externalClusters:
    - name: immich-db-backup
      barmanObjectStore:
        destinationPath: s3://immich-offsite-archive-au2/immich/db/
        serverName: immich-db
        s3Credentials:
          accessKeyId:
            name: immich-offsite-restorer
            key: AWS_ACCESS_KEY_ID
          secretAccessKey:
            name: immich-offsite-restorer
            key: AWS_SECRET_ACCESS_KEY
          region:
            name: immich-offsite-restorer
            key: AWS_REGION
  postgresql:
    parameters:
      shared_preload_libraries: "vectors"
  monitoring:
    enablePodMonitor: true
