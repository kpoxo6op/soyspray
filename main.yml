# main.yml
---
- import_playbook: kubespray/cluster.yml

# do getting started so `kubectl get nodes` works

- import_playbook: playbooks/deploy-argocd-ingress.yml
  tags: postinstall

- import_playbook: playbooks/enable-argocd-kustomize.yml
  tags: postinstall

- import_playbook: playbooks/publish-argocd-service.yml
  tags: postinstall

- import_playbook: playbooks/install-node-tools.yml
  tags: postinstall

- import_playbook: playbooks/set-node-labels.yml
  tags: postinstall

- import_playbook: playbooks/initialize-longhorn-storage.yml
  tags: postinstall

# manual step playbooks/yaml/argocd-apps/longhorn/values.yaml flip service monitor to false
- import_playbook: playbooks/deploy-argocd-apps.yml
  tags: longhorn

# ensure sync worked at http://192.168.1.21/applications/argocd/longhorn
# it may take around 10mins to sync
# argocd creds are admin/password

- import_playbook: playbooks/deploy-argocd-apps.yml
  tags: cert-manager,external-dns

# wait certs to be ready (around 3:30mins)
# watch kubectl get cert -A
- import_playbook: playbooks/sync-certificates.yml

# check access to https://longhorn.soyspray.vip
