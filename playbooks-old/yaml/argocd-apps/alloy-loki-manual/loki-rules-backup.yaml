apiVersion: v1
kind: ConfigMap
metadata:
  name: loki-rules-backup
  namespace: monitoring
  labels:
    app.kubernetes.io/name: loki
    app.kubernetes.io/component: ruler
    app.kubernetes.io/part-of: observability
    loki.grafana.com/rule: "1"
data:
  immich-backup.yaml: |
    groups:
      - name: immich-backup
        rules:
          - alert: ImmichMediaBackupFailureImmediate
            expr: |
              sum by (namespace) (
                count_over_time({namespace="immich", container="aws-sync"}
                  |~ "(?i)(an error occurred \\(|error|accessdenied|expiredtoken|slowdown|requesttimetoo skewed|read-only file system|connection reset)" [5m])
              ) > 0
            for: 2m
            labels:
              severity: warning
            annotations:
              summary: "Immich media offsite sync failed (aws-cli errors)"
              description: "aws-cli in immich-media-offsite-sync is emitting errors in the last 5m."

  immich-backup-events.yaml: |
    groups:
      - name: immich-backup-events
        rules:
          - alert: ImmichMediaBackupBackoffLimitExceeded
            expr: |
              count_over_time({cluster="soyspray", job="kubernetes-events"} |= "BackoffLimitExceeded" |= "immich-media-offsite-sync" [5m]) > 0
            for: 1m
            labels:
              severity: warning
            annotations:
              summary: "immich-media-offsite-sync backoff limit exceeded"
              description: "Kubernetes reports BackoffLimitExceeded for immich-media-offsite-sync."

  cnpg-backup.yaml: |
    groups:
      - name: cnpg-backup
        rules:
          - alert: CNPGBackupBarmanError
            expr: |
              sum by (namespace) (
                count_over_time({namespace="postgresql"} |= "barman"
                  |~ "(?i)(error|failed|fatal)" [5m])
              ) > 0
            for: 2m
            labels:
              severity: critical
            annotations:
              summary: "CNPG barman backup error"
              description: "CNPG cluster logs contain barman ERROR/failed in the last 5m."

          - alert: CNPGWalArchiveFailure
            expr: |
              sum by (namespace) (
                count_over_time({namespace="postgresql"}
                  |~ "(?i)archive_command.*(failed|returned)" [5m])
              ) > 0
            for: 2m
            labels:
              severity: critical
            annotations:
              summary: "PostgreSQL WAL archiving failing (archive_command)"
              description: "postgres reports archive_command failure in the last 5m."

  backup-error-burst.yaml: |
    groups:
      - name: backup-error-burst
        rules:
          - alert: BackupErrorBurst
            expr: |
              sum by (namespace) (
                rate(({namespace=~"immich|postgresql"} |~ "(?i)(error|failed|fatal)")[5m])
              ) > 0.5
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "Backup error burst"
              description: "Sustained error rate detected across backup logs."

